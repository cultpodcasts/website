name: Build Mobile Apps

on:
  push:
    branches: [ main, feature/sign-apk ]
    paths:
      - 'cultpodcasts/src/**'
      - 'cultpodcasts/angular.json'
      - 'cultpodcasts/package.json'
      - 'cultpodcasts/build-apk.sh'
      - '.github/workflows/mobile-build.yml'
  workflow_dispatch:
    inputs:
      release:
        description: 'Build as release (requires signing)'
        required: false
        default: 'false'

env:
  NODE_VERSION: '20'

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: cultpodcasts/package-lock.json

      - name: Install dependencies
        run: cd cultpodcasts && npm ci

      - name: Build web app
        run: cd cultpodcasts && env=production ./build.sh

      - name: Initialize Bubblewrap project
        run: |
          cd cultpodcasts
          # Create twa-manifest.json with version info from package.json
          node -e "
            const fs = require('fs');
            const crypto = require('crypto');
            
            // Read version from package.json
            const packageJson = require('./package.json');
            const appVersion = packageJson.version;
            
            // Convert semantic version (e.g., 1.8.0) to integer version code
            // Multiply major*10000 + minor*100 + patch
            const versionParts = appVersion.split('.');
            const major = parseInt(versionParts[0], 10) || 0;
            const minor = parseInt(versionParts[1], 10) || 0;
            const patch = parseInt(versionParts[2], 10) || 0;
            const appVersionCode = (major * 10000) + (minor * 100) + patch;
            
            const manifest = {
              name: 'Cult Podcasts',
              packageId: 'com.cultpodcasts.twa',
              host: 'cultpodcasts.com',
              launchUrl: '/',
              startUrl: '/',
              display: 'standalone',
              orientation: 'portrait-primary',
              themeColor: '#fafafa',
              themeColorDark: '#000000',
              navigationColor: '#fafafa',
              backgroundColor: '#fafafa',
              iconUrl: 'https://cultpodcasts.com/assets/icons/icon-192x192.png',
              maskableIconUrl: 'https://cultpodcasts.com/assets/icons/icon-192x192.png',
              appVersion: appVersion,
              appVersionCode: appVersionCode,
              splashScreenFadeOutDuration: 300,
              enableNotifications: true,
              enableSiteSettingsShortcut: true,
              fallbackType: 'webview'
            };
            
            // Add signing key configuration if secrets are available
            const keystorePassword = process.env.KEYSTORE_PASSWORD;
            const keyPassword = process.env.KEY_PASSWORD;
            const keyAlias = process.env.KEY_ALIAS || 'android';
            
            if (keystorePassword && keyPassword) {
              manifest.signingKey = {
                path: './android.keystore',
                alias: keyAlias,
                keyPassword: keyPassword,
                storePassword: keystorePassword
              };
            }
            
            fs.writeFileSync('twa-manifest.json', JSON.stringify(manifest, null, 2));
            
            // Generate SHA1 hash for manifest validation
            const manifestContent = JSON.stringify(manifest);
            const hash = crypto.createHash('sha1').update(manifestContent).digest('hex');
            fs.writeFileSync('.twa-manifest.json.sha1', hash);
            
            console.log(\`Created twa-manifest.json with app version \${appVersion} (code: \${appVersionCode})\`);
          "
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}

      - name: Decode Android Keystore
        run: |
          cd cultpodcasts
          if [ ! -z "${{ secrets.JAVA_KEYSTORE }}" ]; then
            echo "${{ secrets.JAVA_KEYSTORE }}" | base64 -d > android.keystore
            echo "Keystore decoded successfully"
            ls -lh android.keystore
          fi

      - name: Build APK with Bubblewrap (Docker - automated with expect)
        run: |
          cd cultpodcasts
          
          docker run --rm \
            --entrypoint bash \
            -v $(pwd)/build-apk.sh:/tmp/build-apk.sh:ro \
            -v $(pwd):/workspace \
            -w /workspace \
            -e BUBBLEWRAP_KEYSTORE_PASSWORD="${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            -e BUBBLEWRAP_KEY_PASSWORD="${{ secrets.ANDROID_KEY_PASSWORD }}" \
            ghcr.io/googlechromelabs/bubblewrap:latest \
            /tmp/build-apk.sh

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: cultpodcasts-apk
          path: |
            cultpodcasts/app-release-signed.apk
            cultpodcasts/app-release-bundle.aab
          retention-days: 30

      - name: Create Release (Android)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            cultpodcasts/app-release-signed.apk
            cultpodcasts/app-release-bundle.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Play Store (optional)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          if [ ! -z "${{ secrets.PLAY_STORE_KEY }}" ]; then
            echo "Play Store upload would be configured here"
            echo "Requires: PLAY_STORE_KEY secret with service account JSON"
          fi

  build-ios:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: cultpodcasts/package-lock.json

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcode-select --print-path

      - name: Install dependencies
        run: cd cultpodcasts && npm ci

      - name: Build web app
        run: cd cultpodcasts && env=production ./build.sh

      - name: Install Bubblewrap (for HTML to Swift assets)
        run: npm install -g @bubblewrap/cli

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Create iOS Xcode project (if needed)
        run: |
          if [ ! -d "ios-app/platforms/ios" ]; then
            echo "Creating iOS Xcode project with Cordova..."
            npm install -g cordova
            # Remove the ios-app directory to start fresh
            rm -rf ios-app
            # Create with Cordova
            cordova create ios-app com.cultpodcasts.app "CultPodcasts"
            cd ios-app
            cordova platform add ios
            cd ..
          else
            echo "iOS project already exists"
          fi
          echo "iOS project structure:"
          find ios-app/platforms/ios -name "*.xcodeproj" -type d 2>/dev/null || echo "No xcodeproj found"

      - name: Copy web assets to iOS
        run: |
          cd cultpodcasts
          # Copy built web assets to iOS www directory (created by Cordova)
          cp -r dist/browser/* ../ios-app/www/ || true

      - name: Install iOS dependencies
        run: |
          cd ios-app
          # Install CocoaPods dependencies for iOS
          if [ -f "Podfile" ]; then
            pod install
          fi
          cd ..

      - name: Build iOS app (Debug)
        if: github.event.inputs.release != 'true'
        run: |
          cd ios-app/platforms/ios
          # Find the actual scheme name
          SCHEME=$(find . -name "*.xcodeproj" -type d | head -1 | xargs basename | sed 's/\.xcodeproj$//')
          echo "Building scheme: $SCHEME"
          xcodebuild -scheme "$SCHEME" -configuration Debug -derivedDataPath build
          cd ../../..

      - name: Build iOS app (Release)
        if: github.event.inputs.release == 'true' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
        run: |
          cd ios-app/platforms/ios
          # Find the actual scheme name
          SCHEME=$(find . -name "*.xcodeproj" -type d | head -1 | xargs basename | sed 's/\.xcodeproj$//')
          echo "Building scheme: $SCHEME"
          
          # For production, import signing certificate and provisioning profile
          if [ ! -z "${{ secrets.IOS_CERTIFICATE_P12 }}" ]; then
            echo "Setting up signing certificate..."
            echo "${{ secrets.IOS_CERTIFICATE_P12 }}" | base64 -d > Certificate.p12
            security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
            security import Certificate.p12 -k build.keychain -P "${{ secrets.CERTIFICATE_PASSWORD }}" -A
            security set-key-partition-list -S apple-tool:,apple: -s lsa- -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          fi
          
          xcodebuild -scheme "$SCHEME" -configuration Release -derivedDataPath build -archivePath build/CultPodcasts.xcarchive archive 2>&1 || echo "Archive may require provisioning profiles"
          
          if [ -d "build/CultPodcasts.xcarchive" ]; then
            xcodebuild -exportArchive -archivePath build/CultPodcasts.xcarchive -exportOptionsPlist ../../ExportOptions.plist -exportPath build/ipa
          fi
          cd ../../..

      - name: Upload iOS build artifact (Debug)
        if: github.event.inputs.release != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cultpodcasts-ios-debug
          path: cultpodcasts/ios-app/platforms/ios/build/
          retention-days: 7

      - name: Upload iOS IPA artifact (Release)
        if: (github.event.inputs.release == 'true' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))) && hashFiles('cultpodcasts/ios-app/platforms/ios/build/ipa/') != ''
        uses: actions/upload-artifact@v4
        with:
          name: cultpodcasts-ios-release
          path: cultpodcasts/ios-app/platforms/ios/build/ipa/**/*.ipa
          retention-days: 30

      - name: Create Release (iOS)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: cultpodcasts/ios-app/build/ipa/**/*.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to App Store (optional)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          if [ ! -z "${{ secrets.APP_STORE_KEY }}" ]; then
            echo "App Store upload would be configured here"
            echo "Requires: APP_STORE_KEY_ID, APP_STORE_ISSUER_ID, APP_STORE_KEY secrets"
          fi
