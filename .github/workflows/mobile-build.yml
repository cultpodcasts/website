name: Build Mobile Apps

on:
  push:
    branches: [ main, feature/bubblewrap ]
    paths:
      - 'src/**'
      - 'angular.json'
      - 'package.json'
      - '.github/workflows/mobile-build.yml'
  workflow_dispatch:
    inputs:
      release:
        description: 'Build as release (requires signing)'
        required: false
        default: 'false'

env:
  NODE_VERSION: '20'

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: cultpodcasts/package-lock.json

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install dependencies
        run: cd cultpodcasts && npm ci

      - name: Build web app
        run: cd cultpodcasts && env=production ./build.sh

      - name: Install Bubblewrap
        run: npm install -g @bubblewrap/cli

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses || true

      - name: Copy web app to Bubblewrap
        run: |
          cd cultpodcasts
          mkdir -p app-web
          cp -r dist/browser/* app-web/ || true

      - name: Build APK with Bubblewrap
        run: |
          cd cultpodcasts
          (echo "No"; echo "$JAVA_HOME"; yes) | bubblewrap build

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: cultpodcasts-apk
          path: cultpodcasts/artifacts/*.apk
          retention-days: 30

      - name: Create Release (Android)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: cultpodcasts/artifacts/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Play Store (optional)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          if [ ! -z "${{ secrets.PLAY_STORE_KEY }}" ]; then
            echo "Play Store upload would be configured here"
            echo "Requires: PLAY_STORE_KEY secret with service account JSON"
          fi

  build-ios:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: cultpodcasts/package-lock.json

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcode-select --print-path

      - name: Install dependencies
        run: cd cultpodcasts && npm ci

      - name: Build web app
        run: cd cultpodcasts && env=production ./build.sh

      - name: Install Bubblewrap (for HTML to Swift assets)
        run: npm install -g @bubblewrap/cli

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Create iOS Xcode project (if needed)
        run: |
          if [ ! -d "ios-app/platforms/ios" ]; then
            echo "Creating iOS Xcode project with Cordova..."
            npm install -g cordova
            # Remove the ios-app directory to start fresh
            rm -rf ios-app
            # Create with Cordova
            cordova create ios-app com.cultpodcasts.app "CultPodcasts"
            cd ios-app
            cordova platform add ios
            cd ..
          else
            echo "iOS project already exists"
          fi
          echo "iOS project structure:"
          find ios-app/platforms/ios -name "*.xcodeproj" -type d 2>/dev/null || echo "No xcodeproj found"

      - name: Copy web assets to iOS
        run: |
          cd cultpodcasts
          # Copy built web assets to iOS www directory (created by Cordova)
          cp -r dist/browser/* ../ios-app/www/ || true

      - name: Install iOS dependencies
        run: |
          cd ios-app
          # Install CocoaPods dependencies for iOS
          if [ -f "Podfile" ]; then
            pod install
          fi
          cd ..

      - name: Build iOS app (Debug)
        if: github.event.inputs.release != 'true'
        run: |
          cd ios-app/platforms/ios
          # Find the actual scheme name
          SCHEME=$(find . -name "*.xcodeproj" -type d | head -1 | xargs basename | sed 's/\.xcodeproj$//')
          echo "Building scheme: $SCHEME"
          xcodebuild -scheme "$SCHEME" -configuration Debug -derivedDataPath build
          cd ../../..

      - name: Build iOS app (Release)
        if: github.event.inputs.release == 'true' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
        run: |
          cd ios-app/platforms/ios
          # Find the actual scheme name
          SCHEME=$(find . -name "*.xcodeproj" -type d | head -1 | xargs basename | sed 's/\.xcodeproj$//')
          echo "Building scheme: $SCHEME"
          
          # For production, import signing certificate and provisioning profile
          if [ ! -z "${{ secrets.IOS_CERTIFICATE_P12 }}" ]; then
            echo "Setting up signing certificate..."
            echo "${{ secrets.IOS_CERTIFICATE_P12 }}" | base64 -d > Certificate.p12
            security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
            security import Certificate.p12 -k build.keychain -P "${{ secrets.CERTIFICATE_PASSWORD }}" -A
            security set-key-partition-list -S apple-tool:,apple: -s lsa- -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          fi
          
          xcodebuild -scheme "$SCHEME" -configuration Release -derivedDataPath build -archivePath build/CultPodcasts.xcarchive archive 2>&1 || echo "Archive may require provisioning profiles"
          
          if [ -d "build/CultPodcasts.xcarchive" ]; then
            xcodebuild -exportArchive -archivePath build/CultPodcasts.xcarchive -exportOptionsPlist ../../ExportOptions.plist -exportPath build/ipa
          fi
          cd ../../..

      - name: Upload iOS build artifact (Debug)
        if: github.event.inputs.release != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cultpodcasts-ios-debug
          path: cultpodcasts/ios-app/platforms/ios/build/
          retention-days: 7

      - name: Upload iOS IPA artifact (Release)
        if: (github.event.inputs.release == 'true' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))) && hashFiles('cultpodcasts/ios-app/platforms/ios/build/ipa/') != ''
        uses: actions/upload-artifact@v4
        with:
          name: cultpodcasts-ios-release
          path: cultpodcasts/ios-app/platforms/ios/build/ipa/**/*.ipa
          retention-days: 30

      - name: Create Release (iOS)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: cultpodcasts/ios-app/build/ipa/**/*.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to App Store (optional)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          if [ ! -z "${{ secrets.APP_STORE_KEY }}" ]; then
            echo "App Store upload would be configured here"
            echo "Requires: APP_STORE_KEY_ID, APP_STORE_ISSUER_ID, APP_STORE_KEY secrets"
          fi
